<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encrypt and decrypt Uint8Array data with a password</title>
    <script src="../js/jquery.min.js"></script>
    <style type="text/css">
    .txtarea {
        width:600px;
        height:200px;
    }
    </style>
</head>
<body>
    <h2>AES Encryption</h2>
    The following algorithms will be used based on the size of the key:
    16 bytes = AES-128
    24 bytes = AES-192
    32 bytes = AES-256
    <br />

<script src="../openpgp.min.js"></script>
Passwort:<br />
<input id="password1" value="Harter Tobak1234" />
<input id="password2" value="test 2 345671235" />
<input id="password3" value="Password 33333" />
<br /><br />
Input:<br />
<textarea id="inputText" class="txtarea">test 1234</textarea>
<br />
Encrypted:<br />
<textarea id="encryptedTxt" class="txtarea"></textarea>
<br />
Decrypted:<br />
<textarea id="decryptedTxt" class="txtarea"></textarea>

<script>

function buf2hex(buffer) { // buffer is an ArrayBuffer
  return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
}

function toHexString(byteArray) {
  return Array.prototype.map.call(byteArray, function(byte) {
    return ('0' + (byte & 0xFF).toString(16)).slice(-2);
  }).join('');
}
function toByteArray(hexString) {
  var result = [];
  for (var i = 0; i < hexString.length; i += 2) {
    result.push(parseInt(hexString.substr(i, 2), 16));
  }
  return result;
}

(async () => {
    doEncrypt = async function() {
    var passwd1 = $('#password1').text();
    var passwd2 = $('#password2').text();
    var passwd3 = $('#password3').text();

    var cleartext = $('#inputText').val();

    const { message } = await openpgp.encrypt({
        message: openpgp.message.fromText(cleartext), // input as Message object
        passwords: [passwd1],                                             // multiple passwords possible
        armor: false                                                             // don't ASCII armor (for Uint8Array output)
    });
    const encrypted = message.packets.write(); // get raw encrypted packets as Uint8Array

        //console.log(encrypted)
        $('#encryptedTxt').val(encrypted);

        doDecrypt();
    }

    doDecrypt = async function() {
        var encryptedd = toByteArray($('#encryptedTxt').val());
        var passwd1 = $('#password1').text();

        var encrypted = new Uint8Array(encryptedd);

        const { data: decrypted } = await openpgp.decrypt({
            message: await openpgp.message.read(encrypted), // parse encrypted bytes
            passwords: [passwd1],                    // decrypt with password
        });

        //console.log(decrypted)
        $('#decryptedTxt').val(decrypted);
    };
})();

doEncrypt()
$('#inputText').bind('input propertychange', function() {
    doEncrypt()
});
$('#encryptedTxt').bind('input propertychange', function() {
    doDecrypt()
});

</script>
    
</body>
</html>